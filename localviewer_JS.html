<script type="module">
  import {
    initWavesurfer,
    getWavesurfer,
    getPlugin,
    replacePlugin,
    createSpectrogramPlugin,
    getCurrentColorMap,
  } from './modules/wsManager.js';

  import { initZoomControls } from './modules/zoomControl.js';
  import { initFileLoader } from './modules/fileLoader.js';
  import { initBrightnessControl } from './modules/brightnessControl.js';
  import { initFrequencyHover } from './modules/frequencyHover.js';
  import { drawTimeAxis, drawFrequencyGrid } from './modules/axisRenderer.js';
  import { initScrollSync } from './modules/scrollSync.js';
  import { initFrequencyRangeControl } from './modules/frequencyRangeControl.js';

  const container = document.getElementById('spectrogram-only');
  const viewer = document.getElementById('viewer-container');
  const timeAxis = document.getElementById('time-axis');
  const timeWrapper = document.getElementById('time-axis-wrapper');
  const timeLabel = document.getElementById('time-label');
  const freqGrid = document.getElementById('freq-grid');
  const freqLabelContainer = document.getElementById('freq-labels');
  const spectrogramHeight = 800;
  let duration = 0;
  const getDuration = () => duration;

  const guanoOutput = document.getElementById('guano-output');
  document.getElementById('fileInput').addEventListener('change', async function(event) {
    const file = event.target.files[0];
    if (!file) return;

    const buffer = await file.arrayBuffer();
    const view = new DataView(buffer);
    const textDecoder = new TextDecoder("utf-8");
    let pos = 12;
    let foundGuano = null;

    while (pos < view.byteLength) {
      const chunkId = String.fromCharCode(
        view.getUint8(pos),
        view.getUint8(pos + 1),
        view.getUint8(pos + 2),
        view.getUint8(pos + 3)
      );

      const chunkSize = view.getUint32(pos + 4, true);
      const chunkData = new Uint8Array(buffer, pos + 8, chunkSize);
      const chunkText = textDecoder.decode(chunkData);

      if (chunkText.includes("GUANO|Version:")) {
        foundGuano = chunkText;
        break;
      }

      pos += 8 + chunkSize;
      if (chunkSize % 2 === 1) pos += 1;
    }

    guanoOutput.textContent = foundGuano || '(No GUANO metadata found in file)';
  });

  initWavesurfer({
    container,
    url: 'https://raw.githubusercontent.com/PanTong55/spectrogram/main/recording/LCW-B_20201110_223912.wav',
    sampleRate: 256000,
  });

  let currentFreqMin = 0;
  let currentFreqMax = 128;

  const zoomControl = initZoomControls(getWavesurfer(), container, getDuration, renderAxes);

  const freqControl = initFrequencyRangeControl({
    freqMinInputId: 'freqMinInput',
    freqMaxInputId: 'freqMaxInput',
    applyBtnId: 'applyFreqRangeBtn',
    spectrogramHeight,
    getCurrentColorMap,
    replacePlugin,
    getWavesurfer,
    zoomControl,
    onRangeUpdated: (min, max) => {
      currentFreqMin = min;
      currentFreqMax = max;
    }
  });

  const renderAxes = () => {
    drawTimeAxis({
      containerWidth: container.scrollWidth,
      duration,
      zoomLevel: zoomControl.getZoomLevel(),
      axisElement: timeAxis,
      labelElement: timeLabel,
    });

    drawFrequencyGrid({
      gridCanvas: freqGrid,
      labelContainer: freqLabelContainer,
      containerElement: container,
      spectrogramHeight,
      maxFrequency: currentFreqMax - currentFreqMin,
      offsetKHz: currentFreqMin,
    });

    initFrequencyHover({
      viewerId: 'viewer-container',
      wrapperId: 'viewer-wrapper',
      hoverLineId: 'hover-line',
      freqLabelId: 'freq-label',
      spectrogramHeight,
      maxFrequency: currentFreqMax,
      minFrequency: currentFreqMin,
    });
  };

  initBrightnessControl({
    brightnessSliderId: 'brightnessSlider',
    gainSliderId: 'gainSlider',
    brightnessValId: 'brightnessVal',
    gainValId: 'gainVal',
    resetBtnId: 'resetButton',
    onColorMapUpdated: (colorMap) => {
      replacePlugin(colorMap, spectrogramHeight, currentFreqMin, currentFreqMax);
      setTimeout(() => zoomControl.applyZoom(), 20);
    },
  });

  initFileLoader({
    fileInputId: 'fileInput',
    wavesurfer: getWavesurfer(),
    spectrogramHeight,
    colorMap: [],
    onPluginReplaced: () => {
      setTimeout(() => {
        duration = getWavesurfer().getDuration();
        getPlugin()?.render();
        zoomControl.applyZoom();
      }, 100);
    },
  });

  initScrollSync({
    scrollSourceId: 'viewer-container',
    scrollTargetId: 'time-axis-wrapper',
  });

  getWavesurfer().on('ready', () => {
    duration = getWavesurfer().getDuration();
    zoomControl.applyZoom();
    getPlugin()?.render();
  });

  getWavesurfer().on('decode', () => {
    duration = getWavesurfer().getDuration();
    zoomControl.applyZoom();
  });

  document.body.addEventListener('touchstart', () => {
    if (getWavesurfer()?.backend?.ac?.state === 'suspended') {
      getWavesurfer().backend.ac.resume();
    }
  }, { once: true });
</script>
