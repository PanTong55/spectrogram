# 🧪 WASM 集成測試指南

## 快速開始

### 方法 1：使用 Python HTTP 服務器（推薦）

```bash
cd /workspaces/spectrogram
python3 -m http.server 8000
```

然後在瀏覽器中打開：
```
http://localhost:8000/waveform-wasm-test.html
```

### 方法 2：使用 Node.js HTTP 服務器

```bash
cd /workspaces/spectrogram
npx http-server -p 8000
```

然後在瀏覽器中打開：
```
http://localhost:8000/waveform-wasm-test.html
```

### 方法 3：使用 VS Code 內置的簡單瀏覽器

在 VS Code 中按 `Ctrl+K Ctrl+O`，選擇：
```
waveform-wasm-test.html
```

## 📊 測試頁面說明

### 測試 1：WASM 模組加載 ✅
檢查：
- WASM 模組是否成功初始化
- `compute_peaks_optimized` 函數是否可用
- `normalize_buffer_multichannel` 函數是否可用

**預期結果**：
```
✅ WASM 模組已加載
✅ compute_peaks_optimized 可用
✅ normalize_buffer_multichannel 可用
```

### 測試 2：峰值計算正確性 ⚡
- 生成 1 秒的 44.1kHz 測試音頻
- 計算 8,000 個峰值點
- 測量計算時間

**預期結果**：
```
✅ 峰值計算成功
計算時間：2-5ms
結果：Float32Array[8000] 

樣本統計：
- 最小值：0.0
- 最大值：1.0
- 平均值：~0.5 (取決於信號)
```

### 測試 3：性能基準 📈
- 生成 5 秒的 44.1kHz 測試音頻 (220,500 樣本)
- 運行 10 次迭代的峰值計算
- 計算吞吐量（樣本/秒）

**預期結果**：
```
✅ 性能基準測試完成

迭代 1-10：2-5ms 每次
平均時間：3.2ms
最小時間：2.1ms
最大時間：4.8ms

吞吐量：68,906,250 樣本/秒
      或 ~69 百萬樣本/秒
```

## 🔍 測試結果解釋

### 綠色 ✅ 表示什麼？

| 指標 | 期望 | 含義 |
|------|------|------|
| WASM 加載 | ✅ | 二進制文件正確加載 |
| 計算結果 | ✅ | Float32Array 返回無誤 |
| 無異常 | ✅ | 沒有運行時錯誤 |
| 時間 | 2-5ms | WASM 性能良好 |

### 紅色 ❌ 表示什麼？

| 錯誤 | 原因 | 解決方案 |
|------|------|----------|
| WASM 加載失敗 | 文件不存在或 CORS | 檢查 modules/ 目錄 |
| 函數未定義 | WASM 未初始化 | 檢查 import 語句 |
| 計算失敗 | WASM 錯誤 | 查看控制台日誌 |
| 超時 | 未知原因 | 刷新頁面，檢查網絡 |

## 🐛 調試技巧

### 打開瀏覽器開發者工具

1. 按 `F12` 或右鍵 → "檢查"
2. 點擊 "Console" 標籤
3. 查看任何錯誤信息

### 常見錯誤信息

**錯誤 1：Failed to fetch module**
```
未找到 './waveform_wasm.js'
解決：確保文件在 modules/ 目錄中
```

**錯誤 2：WASM instantiation failed**
```
WASM 二進制文件損壞或不兼容
解決：重新編譯 WASM 模組
```

**錯誤 3：Function not defined**
```
導入失敗或初始化未完成
解決：等待 WASM 加載完成
```

## 📈 性能對比

### 理論值（基於 Spectrogram 優化）

| 操作 | JS 版本 | WASM 版本 | 改進倍數 |
|------|--------|----------|---------|
| 5 秒音頻 | 15-30ms | 3-5ms | 5-10 倍 |
| 計算吞吐量 | 7-14 百萬樣本/秒 | 50-75 百萬樣本/秒 | 5-10 倍 |

### 實際測試中查看

運行性能測試時，檢查：
1. **平均時間**：應 < 5ms
2. **最大時間**：應 < 10ms
3. **吞吐量**：應 > 50 百萬樣本/秒

## ✅ 集成測試清單

完成以下步驟驗證完整集成：

- [ ] WASM 模組加載成功
- [ ] 峰值計算返回正確結果
- [ ] 性能測試完成
- [ ] 沒有控制台錯誤
- [ ] 計算時間在預期範圍內
- [ ] 打開 `sonoradar.html` 加載音頻成功
- [ ] 導出峰值數據成功
- [ ] 大型文件（>100MB）不會凍結 UI

## 🚀 下一步

1. **集成到主應用**
   ```bash
   # 在 sonoradar.html 中測試
   # 加載一個大型音頻文件
   # 驗證 exportPeaks() 正常工作
   ```

2. **性能基準測試**
   ```bash
   # 對比 JS vs WASM 版本
   # 記錄測量結果
   # 驗證改進倍數
   ```

3. **錯誤處理驗證**
   ```bash
   # 測試 WASM 加載失敗場景
   # 驗證後備到 JS 版本
   # 確保無中斷
   ```

---

**最後更新**：2025-12-05
**難度等級**：⭐ 簡單（自動化測試）
