<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wavesurfer WASM é›†æˆæ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background-color: #f9f9f9;
            border-left: 4px solid #4CAF50;
            border-radius: 4px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background-color: #c8e6c9; color: #2e7d32; }
        .error { background-color: #ffcdd2; color: #c62828; }
        .info { background-color: #bbdefb; color: #1565c0; }
        button {
            padding: 10px 20px;
            margin: 5px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background-color: #45a049; }
        .output {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Wavesurfer WASM é›†æˆæ¸¬è©¦</h1>
        
        <div class="test-section">
            <h2>æ¸¬è©¦ 1: WASM æ¨¡çµ„åŠ è¼‰</h2>
            <button onclick="testWasmLoading()">æ¸¬è©¦åŠ è¼‰</button>
            <div id="test1-output" class="output" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>æ¸¬è©¦ 2: compute_peaks_optimized</h2>
            <button onclick="testComputePeaks()">æ¸¬è©¦å³°å€¼è¨ˆç®—</button>
            <div id="test2-output" class="output" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>æ¸¬è©¦ 3: æ€§èƒ½æ¸¬è©¦</h2>
            <button onclick="testPerformance()">é‹è¡Œæ€§èƒ½æ¸¬è©¦</button>
            <div id="test3-output" class="output" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>æ¸¬è©¦ç‹€æ…‹</h2>
            <div id="status"></div>
        </div>
    </div>

    <script type="module">
        import init, { compute_peaks_optimized, normalize_buffer } from './modules/waveform_wasm.js';

        let wasmReady = false;
        
        async function initWasm() {
            try {
                await init();
                wasmReady = true;
                updateStatus('WASM åˆå§‹åŒ–æˆåŠŸ', 'success');
                return true;
            } catch (error) {
                updateStatus('WASM åˆå§‹åŒ–å¤±æ•—: ' + error.message, 'error');
                return false;
            }
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            const statusEl = document.createElement('div');
            statusEl.className = 'status ' + type;
            statusEl.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            statusDiv.appendChild(statusEl);
            console.log(message);
        }

        function showOutput(testId, text) {
            const output = document.getElementById('test' + testId + '-output');
            output.textContent = text;
            output.style.display = 'block';
        }

        window.testWasmLoading = async function() {
            if (!wasmReady) {
                await initWasm();
            }
            showOutput('1', wasmReady ? 'âœ… WASM å·²æˆåŠŸåŠ è¼‰' : 'âŒ WASM åŠ è¼‰å¤±æ•—');
        };

        window.testComputePeaks = async function() {
            if (!wasmReady) {
                if (!await initWasm()) return;
            }

            try {
                // ç”Ÿæˆæ¸¬è©¦æ•¸æ“š
                const testData = new Float32Array(44100); // 1 ç§’çš„ 44.1kHz éŸ³é »
                for (let i = 0; i < testData.length; i++) {
                    testData[i] = Math.sin(2 * Math.PI * 440 * i / 44100) * 0.5; // 440Hz æ­£å¼¦æ³¢
                }

                const numPeaks = 8000;
                const precision = 10000;

                const startTime = performance.now();
                const peaks = compute_peaks_optimized(testData, numPeaks, precision);
                const endTime = performance.now();

                let output = 'âœ… å³°å€¼è¨ˆç®—å®Œæˆ\n';
                output += `\nè¨ˆç®—æ™‚é–“: ${(endTime - startTime).toFixed(2)}ms\n`;
                output += `è¼¸å…¥æ¨£æœ¬æ•¸: ${testData.length}\n`;
                output += `å³°å€¼æ•¸: ${peaks.length}\n`;
                output += `ç²¾åº¦: ${precision}\n`;
                output += `\nå‰ 10 å€‹å³°å€¼:\n`;
                
                for (let i = 0; i < Math.min(10, peaks.length); i++) {
                    output += `  [${i}]: ${peaks[i].toFixed(6)}\n`;
                }

                output += `\næœ€å¤§å³°å€¼: ${Math.max(...peaks).toFixed(6)}\n`;
                output += `æœ€å°å³°å€¼: ${Math.min(...peaks).toFixed(6)}\n`;

                showOutput('2', output);
                updateStatus('æ¸¬è©¦ 2 å®Œæˆ: å³°å€¼è¨ˆç®—æ­£å¸¸', 'success');
            } catch (error) {
                showOutput('2', 'âŒ éŒ¯èª¤: ' + error.message);
                updateStatus('æ¸¬è©¦ 2 å¤±æ•—: ' + error.message, 'error');
            }
        };

        window.testPerformance = async function() {
            if (!wasmReady) {
                if (!await initWasm()) return;
            }

            try {
                // ç”Ÿæˆå¤§å‹æ¸¬è©¦æ•¸æ“šï¼ˆæ¨¡æ“¬å¯¦éš›éŸ³é »ï¼‰
                const audioSize = 5 * 44100; // 5 ç§’çš„ 44.1kHz éŸ³é » (220,500 æ¨£æœ¬)
                const testData = new Float32Array(audioSize);
                for (let i = 0; i < testData.length; i++) {
                    testData[i] = Math.sin(2 * Math.PI * 440 * i / 44100) * 0.5;
                }

                const numPeaks = 8000;
                const precision = 10000;
                const iterations = 10;

                let output = 'âš¡ æ€§èƒ½æ¸¬è©¦ (10 æ¬¡è¿­ä»£)\n\n';
                const times = [];

                for (let iter = 0; iter < iterations; iter++) {
                    const startTime = performance.now();
                    const peaks = compute_peaks_optimized(testData, numPeaks, precision);
                    const endTime = performance.now();
                    const time = endTime - startTime;
                    times.push(time);
                }

                const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
                const minTime = Math.min(...times);
                const maxTime = Math.max(...times);

                output += `éŸ³é »å¤§å°: ${audioSize} æ¨£æœ¬ (${(audioSize * 4 / 1024).toFixed(1)} KB)\n`;
                output += `å³°å€¼æ•¸: ${numPeaks}\n`;
                output += `\nè¨ˆç®—æ™‚é–“:\n`;
                output += `  å¹³å‡: ${avgTime.toFixed(3)}ms\n`;
                output += `  æœ€å°: ${minTime.toFixed(3)}ms\n`;
                output += `  æœ€å¤§: ${maxTime.toFixed(3)}ms\n`;
                output += `\nååé‡: ${(audioSize / avgTime / 1000).toFixed(2)} è¬æ¨£æœ¬/ms\n`;
                output += `\næ‰€æœ‰è¿­ä»£æ™‚é–“:\n`;
                
                times.forEach((t, i) => {
                    output += `  è¿­ä»£ ${i+1}: ${t.toFixed(3)}ms\n`;
                });

                showOutput('3', output);
                updateStatus('æ¸¬è©¦ 3 å®Œæˆ: æ€§èƒ½æ¸¬è©¦å®Œæˆ', 'success');
            } catch (error) {
                showOutput('3', 'âŒ éŒ¯èª¤: ' + error.message);
                updateStatus('æ¸¬è©¦ 3 å¤±æ•—: ' + error.message, 'error');
            }
        };

        // é é¢åŠ è¼‰æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            updateStatus('æ­£åœ¨åˆå§‹åŒ– WASM...', 'info');
            await initWasm();
        });
    </script>
</body>
</html>
